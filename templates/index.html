<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stock Dashboard - Finnhub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>

   <header>
    <div class="header-tools">
        <a href="https://tholem.pythonanywhere.com/" target="_blank" class="redirect-button">
            Dividend Yield Calculator
        </a>
    </div>
</header>

    
  <header>
    <h1>Live Stock Insights</h1>
    <div class="header-tools">
        <a href="/calculator" class="redirect-button">
            Dividend Growth Calculator
        </a>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
            <em>Dark Mode</em>
        </div>
    </div>
</header>
  <div id="datetime"></div>
  <script>
    function updateDateTime() {
      const now = new Date();
      const options = {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      };
      document.getElementById('datetime').textContent = now.toLocaleString('en-US', options);
    }

    setInterval(updateDateTime, 1000);
    updateDateTime();
  </script>
    <main>
        <section id="stock-container" class="stock-grid">
            <p class="loading-message">Loading stock data... Please wait a moment.</p>
        </section>
    </main>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            setDarkMode(true);
            document.getElementById('checkbox').checked = true;
        }

        document.getElementById('checkbox').addEventListener('change', function() {
            setDarkMode(this.checked);
            localStorage.setItem('theme', this.checked ? 'dark' : 'light');
        });

        async function fetchAndDisplayStocks() {
            try {
                const response = await fetch('/api/stocks');
                const stocks = await response.json();
                const stockContainer = document.getElementById('stock-container');
                stockContainer.innerHTML = '';

                if (Object.keys(stocks).length === 0) {
                    stockContainer.innerHTML = '<p class="loading-message">No stock data available yet. Backend is fetching data or API key might be invalid.</p>';
                    return;
                }

                const sortedSymbols = Object.keys(stocks).sort();

                sortedSymbols.forEach(symbol => {
                    const data = stocks[symbol];
                    const stockCard = document.createElement('div');
                    stockCard.className = 'stock-card';

                    const change = parseFloat(data.change);
                    const percentageChange = parseFloat(data.percentage_change);
                    const changeClass = change >= 0 ? 'positive' : 'negative';
                    const arrowIcon = change >= 0 ? '&#9650;' : '&#9660;';

                    stockCard.innerHTML = `
                        <div class="card-header">
                            ${data.logo ? `<img src="${data.logo}" alt="${data.company_name} Logo" class="company-logo">` : ''}
                            <h2>${data.company_name} (${data.symbol})</h2>
                        </div>
                        <div class="card-body">
                            <p class="current-price">$${data.current_price}</p>
                            <p class="price-change ${changeClass}">
                                ${arrowIcon} ${data.change} (${data.percentage_change}%)
                            </p>
                            <div class="price-details">
                                <p>Open: <span>$${data.open_price}</span></p>
                                <p>High: <span>$${data.high_price}</span></p>
                                <p>Low: <span>$${data.low_price}</span></p>
                                <p>Prev. Close: <span>$${data.prev_close_price}</span></p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <p class="timestamp">Last Update: ${new Date(data.timestamp).toLocaleTimeString()}</p>
                        </div>
                    `;
                    stockContainer.appendChild(stockCard);
                });

            } catch (error) {
                console.error("Error fetching or displaying stock data:", error);
                document.getElementById('stock-container').innerHTML = '<p class="error-message">Error loading stock data. Please check console for details.</p>';
            }
        }

        fetchAndDisplayStocks();
        setInterval(fetchAndDisplayStocks, 10000);
    </script>
</body>
</html>